---
title: ''
output: bookdown::pdf_document2
---
## Study Area and Dataset

We collected paired air and water temperature data from 203 stream segments in the southern and central Appalachian Mountains region of the USA (Fig. \@ref(fig:sites-map)). Mean elevation was `r round(NS204_Sites_Summary.table[3,2], 1)` m (SD:`r round(NS204_Sites_Summary.table[3,3], 1)` m) with a mean channel slope of `r round(NS204_Sites_Summary.table[1,2], 1)` % (SD:`r round(NS204_Sites_Summary.table[1,3], 1)` %) and a mean catchment area of `r round(NS204_Sites_Summary.table[2,2], 1)` km$^2$ (SD:`r round(NS204_Sites_Summary.table[2,3], 1)` km$^2$). Average stream order was 2. Stream segments in the southern Appalachians were generally situated at higher elevation than stream segments in the central Appalachians (mean 734 m vs. 563 m when divided at 37.13$^\circ$ latitude).  Stream segments were located in randomly selected watersheds identified as capable of supporting populations of brook trout to represent a range of brook trout streams in the study region [@ebtjv2006; @li2016]. Located at the downstream outlet of the watersheds, at each segment a logger underwater was paired with a logger affixed to the bank or a tree. Stream and air temperatures were measured every 30 minutes between 2011 and 2015 using remote loggers (Onset Computer Corporation, Bourne, MA 02532). We summarized temperatures to weekly averages for data analysis.

A common drawback of studies of thermal sensitivity is that air temperatures are derived from model outputs or the closest meteorological station [@beaufort2020; @hare2021; @kelleher2012]. This implies that trends in air temperatures used for analysis may not reflect the true trends influencing stream temperature at the local scale [@kanno2014]. Solar radiation and the influence of local topography have been shown to substantially influence variation in the microclimate across the landscape, particularly in mountainous areas [@aalto2017; @tscholl2022]. Furthermore, weather stations are commonly situated in open, flat areas where they miss the thermal effects of topography and tree cover [@defrenne2016; @graae2012]. We overcame this problem by using air temperatures measured in-situ at the same locations where water temperatures were measured. Using these paired air and water temperature loggers, our study design allowed the consideration of highly local atmospheric influence on stream temperature. 

(ref:sites-map-cap) Locations of 203 stream segments where paired air and stream temperature data were collected from 2011-2015. Light green shading represents forested areas, and dark green shading indicates protected areas. The north and south halves of the study region were divided at 37.13$^\circ$ latitude.

```{r sites-map, fig.cap = "(ref:sites-map-cap)", fig.align = "center", out.width = "100%"}
knitr::include_graphics("../Results/v1.0/NS204_Sites_Map_PAs_QGIS 2.jpeg")
```

Each segment was linked using a GIS to the National Hydrography Dataset [NHDplus v2.1, @USGS2016] stream segment on which it was located. Using the NHDplus COMID code for each segment, we then accessed landscape metrics from the NHDplus and the Environmental Protection Agency StreamCat database [@hill2016]. These sources contained 174 variables describing hydrology, land cover, geology, soils, and topography for each segment. While certain variables such as groundwater and stream size have well-defined influences on stream temperature [@beaufort2020; @chang2013; @mayer2012], we chose to include all variables to improve predictive ability.

## Principal Components Analysis

We performed a Bayesian principal components analysis (PCA) of the segment-level NHDplus and StreamCat predictors at 8,695 stream segments of current and potential brook trout habitat identified in the USGS EcoSHEDS (www.usgs.gov/apps/ecosheds) by the Eastern Brook Trout Joint Venture [@ebtjv2006]. The 203 segments with paired stream-air temperature measurements were included in the 8,695 segments. We excluded segments with stream orders greater than five. Variables were centered and scaled. We used a Bayesian PCA due to its ability to take missing values as inputs [@bishop1998; @nounou2002]. Analysis was completed using the “pcaMethods” package in R [@stacklies2007; @rcoreteam2022]. We then extracted the top ten loadings by absolute value for the first five principle components (cumulative R$^2$: 0.60). Lastly, we extracted PCA scores for each of the 203 stream segments where temperature was measured.

## Hierarchical Model

We used a Bayesian hierarchical logistic model to infer stream thermal sensitivity and the effects thereupon of local hydrology and landscapes. The regression slope at the inflection point of the function represents a first-order estimate of the relationship between air and water temperatures [@kelleher2012; @mohseni1998; @morrill2005]. We omitted observations where water or air temperatures were missing. Following @mohseni1998, we fit weekly mean water temperature $T_W$ ($^\circ$C) at stream segment $i = 1,...,203$ and week $t = 1,...,T$ as a function of weekly mean air temperature $T_A$ ($^\circ$C) with:

\begin{equation}
  \text{T}_{Wi,t} \sim \text{normal}\left(\epsilon_i + \frac{\zeta_i - \epsilon_i}{1 + e^{\phi_i(\kappa_i - \text{T}_{Ai,t})}}, \sigma^2\right),
  (\#eq:MohseniModel)
\end{equation}

\noindent where $\zeta_i$ is the maximum weekly mean stream temperature ($^\circ$C) at stream segment $i$, $\epsilon_i$ is the minimum weekly mean stream temperature ($^\circ$C), $\kappa_i$ is the estimated air temperature at the inflection point of the function ($^\circ$C), and $\phi_i$ is a measure of the slope of the function at the inflection point. Furthermore, $\phi_i$ was modeled as a random effect that varies with the principle component (PC) scores:

\begin{equation}
  \phi_i \sim \text{normal}(\theta_0 + \theta_1\text{PC}_{1,i} + \theta_2\text{PC}_{2,i} + \theta_3\text{PC}_{3,i} + \theta_4\text{PC}_{4,i} + \theta_5\text{PC}_{5,i}, \sigma^2_\phi),
  (\#eq:PCAlogistic)
\end{equation}

\noindent where $\bm{\theta}$ represents the contribution of each PC to thermal sensitivity over space. The slope of the function at the inflection point (thermal sensitivity; $\beta_i$) at stream segment $i$ is related to $\phi_i$ using the equation

\begin{equation}
  \beta_i = \frac{\phi_i*(\zeta_i - \epsilon_i)}{4}.
  (\#eq:CalcSlope)
\end{equation}

\noindent We visually evaluated spatial structure in thermal sensitivity by plotting semivariograms of $\bm{\beta}$ values using the 'geoR' package in R [@ribeirojr2022]. We also estimated thermal sensitivity using linear regression, and inferences of thermal sensitivity were nearly identical to those of the nonlinear approach (Appendix \@ref(linear-temperature-model)). Logistic regression slopes were also correlated with slopes from the linear regression (Pearson's r = `r round(cor(weekly_linear_slopes.table$mean, weekly_nonlinear_slopes.table$mean, method = "pearson"), 2)`). We derived $\bm{C}$ to quantify the proportion of variance in thermal sensitivity among the 203 stream segments explained by landscape variables. $\bm{C}$ compares posterior samples of the residual variance in thermal sensitivity ($\bm{\hat{\sigma}^2_\phi}$) to the variance in posterior samples of thermal sensitivity ($\bm{\hat{\phi}}$):

\begin{equation}
  \bm{C} = 1 - \frac{\bm{\hat{\sigma}^2_\phi}}{\text{var}(\bm{\hat{\phi}})}.
  (\#eq:C-phi)
\end{equation}

\noindent Values of $\bm{C}$ range between 0 and 1, with larger $\bm{C}$ values indicative of more variance explained by the principal components of landscape variables. In addition to evaluating variable loading in the PC and the posterior distribution of $\theta$ for that PC, we used Pearson correlation between segment-specific thermal sensitivity ($\bm{\beta}$ from Eq. \@ref(eq:CalcSlope)) and landscape variables at each stream segment because some variables had loadings in more than a single PC. We chose landscape determinants of stream thermal sensitivity by identifying those variables that were both in the most significant PC loadings as defined by their posterior distributions and had the highest absolute correlation coefficients.

We conducted posterior predictive checks for the test statistics of mean and coefficient of variation to evaluate model performance. These checks test for lack of fit using Bayesian $p$-values, defined as the probability that simulated data are more extreme than the observed data [@gelman2004]. Models that fit well result in Bayesian $p$-values that are not close to zero or one. We also evaluated the model using the root mean square error (RMSE) and R$^2$. Lower RMSE values indicate better model fit, and higher R$^2$ values indicate greater variance explained. We implemented the model with Markov Chain Monte Carlo (MCMC) sampling using JAGS with the 'jagsUI' package in R [@kellner2021]. We provide code in online supplements and report noninformative priors in Appendix \@ref(prior-distributions). After a burn-in period of 1,000 samples, three chains were run until 5,000 iterations were reached. We considered convergence as an $\hat{R}$ value of 1.1 or less [@gelman2004]. We report posterior means as point estimates and 95% highest posterior density intervals (HPDIs) as estimates of uncertainty. We considered posterior distributions to be statistically significant when 95% HDPIs did not overlap with zero. We specified diffuse priors for all model parameters, and used posterior mean predicted temperatures for subsequent analyses.

## Thermal Sensitivity Predictions and Gap Analysis

We predicted thermal sensitivity at unsampled brook trout habitat throughout the study region. In Section \@ref(principal-components-analysis), we calculated principal components for 8,695 stream segments of current and potential brook trout habitat. Using these principal components and posterior distributions for $\bm{\theta}$ from Eq. \@ref(eq:PCAlogistic) and Eq. \@ref(eq:CalcSlope), we calculated $\beta_i$ for each segment. We interpolated minimum and maximum water temperatures at stream segments by kriging using the *spPredict* function in the spBayes package [@finley2015]. The minimum and maximum water temperatures were modeled using a linear combination of latitude, longitude, and elevation (m); and the spatial structures were modeled using an exponential covariance function based on pair-wise Euclidean distances.

Finally, we performed a gap analysis [@jennings2000] to evaluate the proportion of preferred thermal habitat that lies in protected areas and compared this to the proportion of total brook trout habitat that occupies conserved areas. Gap analyses allow the identification of valuable habitat that is unconserved. We accessed a shapefile of protected areas in the study area from the US Geological Survey's Protected Areas Database [@PADUS2022]. We included protected areas with USGS Gap Analysis Project Status Codes 1-3. This included at the least protection from conversion of natural land cover and at the most National Park or Wilderness Area designation. In a GIS [@QGIS_software], we clipped all NHDplus stream segments that were at least partially located in these protected areas. We then defined resistant thermal habitat as the lowest 25th percentile of predicted thermal sensitivity values. We calculated the percentage of resistant thermal habitat segments that were located on these stream segments within protected areas. Finally, we compared this percentage to that of all brook trout habitat located in stream segments within protected areas using a Pearson's Chi-squared test.